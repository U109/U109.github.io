分布式场景下，多个服务同时对服务一个流程，比如电商下单场景，需要支付服务进行支付、库存服务扣减库存、订单服务进行订单生成、物流服务更新物流信息等。如果某一个服务执行失败，或者网络不通引起的请求丢失，那么整个系统可能出现数据不一致的原因。

上述场景就是分布式一致性问题，追根到底，分布式一致性的根本原因在于数据的分布式操作，引起的本地事务无法保障数据的原子性引起。

分布式一致性问题的解决思路有两种，一种是分布式事务，一种是尽量通过业务流程避免分布式事务。分布式事务是直接解决问题，而业务规避其实通过解决出问题的地方(解决提问题的人)。其实在真实业务场景中，如果业务规避不是很麻烦的前提，最优雅的解决方案就是业务规避。

## 一、分布式事务分类

分布式事务实现方案从类型上去分`刚性事务`、`柔型事务`：

* 刚性事务满足`CAP`的`CP`理论

* 柔性事务满足`BASE`理论（基本可用，最终一致）

## 二、刚性事务

刚性事务：通常无业务改造，强一致性，原生支持回滚/隔离性，低并发，适合短事务。

原则：刚性事务满足足`CAP`的`CP`理论

> 刚性事务指的是，要使分布式事务，达到像本地式事务一样，具备数据强一致性，从CAP来看，就是说，要达到CP状态。

刚性事务：`XA` 协议（`2PC`、`JTA`、`JTS`）、`3PC`，但由于同步阻塞，处理效率低，不适合大型网站分布式场景。

## 三、柔性事务

柔性事务指的是，不要求强一致性，而是要求最终一致性，允许有中间状态，也就是`Base`理论，换句话说，就是`AP`状态。

与刚性事务相比，柔性事务的特点为：有业务改造，最终一致性，实现补偿接口，实现资源锁定接口，高并发，适合长事务。

柔性事务分为：

* 补偿型
* 异步确保型
* 最大努力通知型。

柔型事务：`TCC/FMT`、`Saga`（状态机模式、`Aop`模式）、本地事务消息、消息事务（半消息）